# 트랜잭션이란?

`트랜잭션(Transaction)`은 데이터베이스에서 수행되는 논리적인 작업의 단위를 말합니다.

## 논리적 작업 단위란?

예를 들어 은행 이체 작업을 진행 하려고 했을때 다음과 같은 단계로 구성 됩니다.

1. 출금: 고객의 계좌에서 일정 금액을 출금하는 단계입니다. 이 단계에서는 고객의 계좌 잔액을 감소시키고, 출금 기록을 작성합니다.

2. 입금: 이체 대상 계좌에 출금한 금액을 입금하는 단계입니다. 이 단계에서는 대상 계좌 잔액을 증가시키고, 입금 기록을 작성합니다.

3. 로그 작성: 출금과 입금 작업에 대한 로그를 작성하는 단계입니다. 이 단계에서는 이체 작업에 대한 로그를 기록합니다.

이러한 단계들을 하나의 논리적인 작업 단위로 묶어서 트랜잭션으로 처리해야 합니다.

왜냐하면 일부 작업만 수행되고 나머지 작업이 실패하는 경우 데이터의 불일치가 발생할 수 있습니다.

## 트랜잭션을 사용하지 않는다면?

위의 상황을 예를 들어 A가 계좌에서 10000원을 보내고 B가 10000원을 받는 도중

입금 기록에 에러가 발생하면 A의 계좌에서 10000원만 차감되고 B의 계좌에는 10000원이 증가되지 않는 이슈가 발생할 것 입니다.

## 트랜잭션의 ACID

트랜잭션의 특징은 4가지로 구분됩니다.

- 원자성 (Atomicity)
- 일관성 (Consistency)
- 독립성 (Isolation)
- 지속성 (Durability)

### 원자성

트랜잭션은 단위가 절대 깨지지 않는 `원자`처럼 `전부 성공` 또는 `전부 실패`해야 합니다.

모든 연산이 정상적으로 수행되면 트랜잭션은 `커밋(Commit)`되어 영구적으로 반영되며,

하나라도 오류가 발생하면 트랜잭션은 `롤백(Rollback)`되어 이전 상태로 복원됩니다.

### 일관성

트랜잭션은 데이터베이스의 무결성 규칙을 준수해야 합니다.

트랜잭션이 수행되기 전과 후에도 데이터베이스는 일관된 상태를 유지해야 합니다.

```
예를 들어, 은행 이체 작업에서 출금과 입금은 일관성을 유지해야 합니다.
출금 작업이 성공하면 출금된 금액이 해당 계좌에서 감소되어야 하고,
입금 작업이 성공하면 입금된 금액이 대상 계좌에 증가되어야 합니다. 이러한 작업들은 일관성을 유지해야 하며,
트랜잭션의 범위 내에서 원자적으로 실행되어야 합니다.
```

### 독립성

동시에 실행되는 여러 트랜잭션들은 서로 영향을 주지 않고 독립적으로 실행되어야 합니다.

트랜잭션은 다른 트랜잭션의 연산 결과를 볼 수 없으며, 중간 단계의 결과가 다른 트랜잭션에 영향을 미치지 않아야 합니다.

예를 들어, id가 1인 행의 값을 변경하기 위해 트랜잭션이 실행 중일 때,

해당 행에 대한 `lock`을 설정하면 다른 트랜잭션이 해당 행을 동시에 변경할 수 없습니다.

이로 인해 트랜잭션의 순차성을 보호하고 동시 접근으로 인한 충돌을 방지할 수 있습니다.

```sql
-- A 세션
START TRANSACTION;

-- id가 1인 행에 대한 lock 설정
SELECT * FROM your_table WHERE id = 1 FOR UPDATE;

-- 해당 행의 값을 변경하는 작업 수행
UPDATE your_table SET column_name = 'new_value' WHERE id = 1;

-- A 세션에서 COMMIT 또는 ROLLBACK이 이루어지지 않았을 때

-- B 세션이 행을 업데이트하여 데드락이 발생
UPDATE your_table SET column_name = 'update_value' WHERE id = 1;
```

### 지속성

트랜잭션이 성공적으로 커밋된 후에는 그 결과가 영구적으로 저장되어야 합니다.
시스템 장애 또는 기타 이유로 인해 데이터베이스에 문제가 발생하더라도, 커밋된 트랜잭션의 결과는 손실되지 않아야 합니다.
