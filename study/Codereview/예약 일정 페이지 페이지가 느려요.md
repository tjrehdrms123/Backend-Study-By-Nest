![](https://lime-demo.s3.amazonaws.com/posts/1678636171376_32305_27384_5151.jpg)

# [ 코드 리뷰 ] 예약 일정 페이지 페이지가 느려요 \~

### 상황 설명

> 교육을 예약 할 수 있는 일자가 언제인지 정원이 얼마나 찼는지 확인 할 수 있는 페이지가 있었고, 페이지가 느리다는 이슈가 생겼다 해결까지의 상황을 기록해보려고한다.

### 현재 코드의 상황 및 문제점

1. 예약을 할수있는 프로그램 일자뿐 아니라 예약을 할 수 없는 예약 프로그램 건도 모두 가져오고 있다.(기존에는 문제가 없었지만, 프로그램건이 많아지면서 쿼리문 속도가 느려졌다.)
2. 정원을 체크하기 위해 쿼리문을 작성한 후 반복문을 돌려야 됐다. 하지만 문제점은 해당 쿼리문이 예약을 할수 있는 예약건을 가져오는 1번 Query문의 PK에 의존하고 있었다.

## 코드로 예시 로직 알아보기

> 예시로 작성한 로직이다.

```js
const 에약프로그램_쿼리 = `SELECT ... FROM 예약프로그램 테이블 LEFT JOIN 주말 예약 프로그램`;
let 예약인원;
const 에약프로그램_쿼리.foreach((item, index) => {
  예약인원_쿼리 = `SELECT ... FROM 예약건 테이블 WHERE key = ${item.primaryKey}`;
  while(0 > 예약인원_쿼리.length){
    예약인원_쿼리.length - 1;
    예약인원 += 예약인원_쿼리['인원'];
  }
});
```

## 원인에 대해서

> 예약건의 쿼리를 코드상이 아닌 단독으로 RDMS툴에서 돌렸을떄 아래와 같은 상세 정보를 얻을 수 있었다.

* 예약건\_쿼리
    * 실행시간 : 1.317ms
    * 조회된 행 : 8301rows
* 예약인원\_쿼리
    * 실행시간 : 0.012ms
    * 조회된 행 : 804rows
* 전체 반목문이 도는 횃수 : 8301 \* 805 = `6,682,305`번

> 기존 코드에서는 과거 예약 프로그램 갯수가 적어서 문제가 없었던 것으로 예상이된다.

### 해결 방법

> 예약을 할 수 있는 날짜의 조건이 종료일자 컬럼이 오늘일자 보다 커야되는것을 확인 후 아래의 조건 절을 쿼리문에 추가했다.

```sql
WHERE 종료일자 >= now()
```

## 추후 생각난 방법

> 과거에는 떠오르지 않았지만 생각난 방법이다.

> 위와 같이 조건을 추가하더라도 `중첩 반복문`은 동일하게 `n * n`과 깉은 식으로 나올것이다. 그러므로 `에약프로그램_쿼리`문에 `foreign key`로 연결 시켜 한번에 가져오면 해결될 것 같다고 생각한다.

## 생각 정리

> 반복문안에 반복문이 있는 중첩 반목문에 대해서 다시 생각을 깊게해보는 계기가 되었다.

* 값이 정적인 데이터가 아닌 동적으로 추가되거나 될 예정이라면 사용할때 조심해야겠다.

> DB설계할때 `relation`관계를 잘 설계해야 위와같은 코드를 짜지 않겠구나라는 생각을했다.